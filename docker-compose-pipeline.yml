version: '3.8'

services:
  # 1. The Application Service (Same as before)
  expense-app-pipeline:
    image: node:18-alpine
    container_name: jenkins-expense-container
    working_dir: /app
    ports:
      - "8081:3000"
    volumes:
      - .:/app
      - ./data:/app/data
    command: sh -c "npm install && node server.js"
    restart: always

  # 2. The Test Service (New!)
  expense-tester:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: jenkins-test-runner
    depends_on:
      - expense-app-pipeline
    environment:
      # Use the container name to talk to the app
      - APP_URL=http://jenkins-expense-container:3000
    volumes:
      - .:/app
      - /app/node_modules # Prevent overwriting node_modules